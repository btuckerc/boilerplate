---
name: opencode-config
description: Comprehensive guide for modifying opencode configuration including agents, models, skills, and system settings. Covers both general opencode conventions and this specific machine's chezmoi-based dotfiles setup.
---

# Skill: OpenCode Configuration Management

A complete reference for modifying OpenCode settings on this machine, covering the chezmoi-managed dotfiles structure and OpenCode's configuration architecture.

## Quick Reference

| What you want to change | Where to edit | Applied via |
|------------------------|---------------|-------------|
| Main model, providers, global settings | `{{ .chezmoi.sourceDir }}/dot_config/opencode/opencode.json` | chezmoi apply |
| Agent definitions (prompts, models, tools) | `{{ .chezmoi.sourceDir }}/dot_config/opencode/opencode.json` or `~/.config/opencode/agents/*.md` | chezmoi apply |
| Global system instructions | `{{ .chezmoi.sourceDir }}/dot_config/opencode/AGENTS.md` | chezmoi apply |
| Skills | `{{ .chezmoi.sourceDir }}/dot_config/opencode/skills/` | chezmoi apply |
| Project-specific settings | `opencode.json` in project root | Direct file (not chezmoi) |
| API keys/credentials | Use `/connect` command in OpenCode | Stored in `~/.local/share/opencode/auth.json` |

---

## Machine-Specific Context

### This Machine's Setup

This machine uses **chezmoi** to manage dotfiles from the repository at `{{ .chezmoi.sourceDir | dir }}/`. 

**Key locations:**
- **Source (chezmoi):** `{{ .chezmoi.sourceDir }}/dot_config/opencode/`
- **Live config:** `~/.config/opencode/`
- **Credentials:** `~/.local/share/opencode/auth.json` (managed by OpenCode, not chezmoi)

**Important:** Always edit files in the **source directory** (`{{ .chezmoi.sourceDir | dir }}/...`) and run `chezmoi apply` to apply changes. Never edit files directly in `~/.config/opencode/` as they will be overwritten.

### Workflow for Changes

```bash
# 1. Edit the source file
cd {{ .chezmoi.sourceDir }}/dot_config/opencode/
# Edit opencode.json, AGENTS.md, or create skills

# 2. Apply changes
chezmoi apply --force ~/.config/opencode/

# 3. Verify
cat ~/.config/opencode/opencode.json
```

---

## OpenCode Configuration Architecture

### Configuration Precedence

OpenCode merges configs in this order (later overrides earlier):

1. **Remote config** (from `.well-known/opencode`) - organizational defaults
2. **Global config** (`~/.config/opencode/opencode.json`) - your global settings
3. **Custom config** (`OPENCODE_CONFIG` env var) - runtime overrides
4. **Project config** (`opencode.json` in project root) - project-specific
5. **`.opencode/` directories** - agents, commands, plugins
6. **Inline config** (`OPENCODE_CONFIG_CONTENT` env var)

### Current Configuration Structure

This machine uses a **file-based prompt approach** for better maintainability:

```
~/.config/opencode/
├── opencode.json          # Main config: models, providers, agents
├── AGENTS.md              # Brief global context (not the main prompt)
├── prompts/               # Agent prompts (easier to edit than JSON!)
│   ├── architect.md       # God Mode prompt for build agent
│   ├── frontend_builder.md
│   └── backend_builder.md
├── skills/                # Skill definitions
│   ├── apply-dotfiles/
│   │   └── SKILL.md
│   ├── install-tools/
│   │   └── SKILL.md
│   └── ...
└── agents/                # Markdown agent definitions (optional)
    └── (can add .md files here)
```

**Note:** Agent prompts are stored in separate files and referenced using `{file:path}` syntax. This makes them much easier to edit than inline JSON strings with `\n` escapes.

---

## 1. Modifying Models

### Model Configuration Location

Models are configured in `opencode.json` under the `provider` key.

### Current Setup

This machine uses **OpenRouter** as the primary provider with Together AI routing for Kimi:

```json
{
  "provider": {
    "openrouter": {
      "models": {
        "moonshotai/kimi-k2.5": {
          "name": "Kimi K2.5 Architect",
          "limit": { "context": 262144, "output": 16384 },
          "parameters": { "temperature": 0.3 },
          "options": {
            "order": ["together"],
            "allow_fallbacks": false
          }
        },
        "deepseek/deepseek-chat": {
          "name": "DeepSeek Chat Worker",
          "parameters": { "temperature": 0.1 }
        }
      }
    }
  }
}
```

### Adding a New Model

**Step 1:** Edit `{{ .chezmoi.sourceDir }}/dot_config/opencode/opencode.json`

**Step 2:** Add model under the appropriate provider:

```json
{
  "provider": {
    "openrouter": {
      "models": {
        "provider/model-id": {
          "name": "Display Name",
          "limit": {
            "context": 128000,
            "output": 8192
          },
          "parameters": {
            "temperature": 0.3,
            "top_p": 0.95
          },
          "options": {
            "order": ["preferred-provider"],
            "allow_fallbacks": false
          }
        }
      }
    }
  }
}
```

**Step 3:** Set as default model:

```json
{
  "model": "openrouter/provider/model-id"
}
```

**Step 4:** Apply changes:

```bash
chezmoi apply --force ~/.config/opencode/opencode.json
```

### Provider-Specific Routing (OpenRouter)

When using OpenRouter, you can specify which upstream provider to use:

```json
{
  "options": {
    "order": ["together", "deepinfra"],
    "allow_fallbacks": true
  }
}
```

Available providers depend on the model. Check openrouter.ai for provider availability.

---

## 2. Modifying Agents

### Agent Types

OpenCode has two agent types:
- **Primary agents:** Main assistants you interact with directly (cycled via Tab key)
- **Subagents:** Specialized assistants invoked via `@mention` or Task tool

### Configuration Methods

**Method 1: JSON in opencode.json** (Recommended for this setup)

Edit `{{ .chezmoi.sourceDir }}/dot_config/opencode/opencode.json`:

```json
{
  "agent": {
    "agent-name": {
      "description": "What this agent does",
      "mode": "primary" | "subagent",
      "model": "provider/model-id",
      "temperature": 0.3,
      "prompt": "{file:~/.config/opencode/prompts/agent-name.md}",
      "tools": {
        "write": true,
        "edit": true,
        "bash": false
      }
    }
  }
}
```

Then create the prompt file:

```bash
# Create the prompt file
cat > {{ .chezmoi.sourceDir }}/dot_config/opencode/prompts/agent-name.md << 'EOF'
### SYSTEM ROLE: [AGENT ROLE]

You are a specialized [type] agent. Your role is to [primary responsibility].

### Guidelines:
1. **Guideline 1** - Description
2. **Guideline 2** - Description
3. **Guideline 3** - Description

### Tool Usage:
- You have [which tools] access
- [Any specific tool usage patterns]

### Output:
[Expected output format]
EOF

# Apply changes
chezmoi apply --force ~/.config/opencode/prompts/
```

**Method 2: Markdown files in agents/ directory**

Create `{{ .chezmoi.sourceDir }}/dot_config/opencode/agents/my-agent.md`:

```markdown
---
description: What this agent does
mode: subagent
model: openrouter/deepseek/deepseek-chat
temperature: 0.1
tools:
  write: true
  edit: true
---

System instructions here...
```

### Current Agent Architecture

This machine implements a **Kimi Architect + DeepSeek Swarm** pattern with file-based prompts:

**opencode.json:**
```json
{
  "agent": {
    "build": {
      "mode": "primary",
      "model": "openrouter/moonshotai/kimi-k2.5",
      "temperature": 0.3,
      "prompt": "{file:~/.config/opencode/prompts/architect.md}"
    },
    "frontend_builder": {
      "mode": "subagent",
      "model": "openrouter/deepseek/deepseek-chat",
      "temperature": 0.1,
      "description": "Specialized frontend developer...",
      "prompt": "{file:~/.config/opencode/prompts/frontend_builder.md}"
    },
    "backend_builder": {
      "mode": "subagent", 
      "model": "openrouter/deepseek/deepseek-chat",
      "temperature": 0.1,
      "description": "Specialized backend developer...",
      "prompt": "{file:~/.config/opencode/prompts/backend_builder.md}"
    }
  }
}
```

**prompts/architect.md:** Contains the "God Mode" Lead Architect system prompt
**prompts/frontend_builder.md:** Frontend specialist instructions
**prompts/backend_builder.md:** Backend specialist instructions

### Adding a New Agent (File-Based Prompt Approach)

**Step 1:** Create the prompt file:

```bash
cd {{ .chezmoi.sourceDir }}/dot_config/opencode/
mkdir -p prompts

cat > prompts/my-new-agent.md << 'EOF'
### SYSTEM ROLE: [ROLE NAME]

You are a specialized [type] agent...

### Guidelines:
1. **Guideline 1**
2. **Guideline 2**

### Tool Usage:
- Use tools X, Y, Z
EOF
```

**Step 2:** Edit `opencode.json` to add the agent:

```json
{
  "agent": {
    "my-new-agent": {
      "description": "Brief description of purpose",
      "mode": "subagent",
      "model": "openrouter/provider/model",
      "temperature": 0.2,
      "prompt": "{file:~/.config/opencode/prompts/my-new-agent.md}",
      "tools": {
        "write": true,
        "edit": true,
        "bash": true,
        "webfetch": false
      }
    }
  }
}
```

**Step 3:** Apply changes:

```bash
chezmoi apply --force ~/.config/opencode/
```

**Step 4:** Invoke the agent:

```
@my-new-agent help me with...
```

Or use the Task tool to delegate to it.

---

## 3. Modifying System Instructions (Prompts)

### File-Based Prompt Approach

This machine uses **file-based prompts** stored in `~/.config/opencode/prompts/` for easier editing. Prompts are referenced using the `{file:path}` syntax.

**Benefits:**
- No escaping required (no `\n` in JSON!)
- Easier to read and edit
- Version control friendly
- Can use markdown formatting

### Current Prompt Structure

```
~/.config/opencode/prompts/
├── architect.md          # Build agent (Kimi) - "God Mode" Lead Architect
├── frontend_builder.md   # Frontend subagent (DeepSeek)
└── backend_builder.md    # Backend subagent (DeepSeek)
```

### Modifying an Existing Prompt

**Step 1:** Edit the prompt file:

```bash
vim {{ .chezmoi.sourceDir }}/dot_config/opencode/prompts/architect.md
```

**Step 2:** Apply changes:

```bash
chezmoi apply --force ~/.config/opencode/prompts/
```

### Creating a New Prompt

**Step 1:** Create the prompt file:

```bash
cd {{ .chezmoi.sourceDir }}/dot_config/opencode/
vim prompts/my-prompt.md
```

**Step 2:** Reference it in opencode.json:

```json
{
  "agent": {
    "my-agent": {
      "prompt": "{file:~/.config/opencode/prompts/my-prompt.md}"
    }
  }
}
```

**Step 3:** Apply both files:

```bash
chezmoi apply --force ~/.config/opencode/
```

### Alternative: Inline Prompts

You can still use inline prompts (less recommended):

```json
{
  "agent": {
    "my-agent": {
      "prompt": "Line 1\nLine 2\nLine 3"
    }
  }
}
```

### Global Instructions (AGENTS.md)

The `AGENTS.md` file contains brief global context. It's no longer used for the main system prompts (those moved to file-based prompts), but you can still use it for:

- High-level architecture notes
- Quick reference information
- Links to other resources

**Location:** `{{ .chezmoi.sourceDir }}/dot_config/opencode/AGENTS.md`

---

## 4. Modifying Skills

### What Are Skills?

Skills are specialized knowledge packages that provide domain-specific instructions and workflows. They can include:
- Markdown documentation
- Scripts
- Reference files

### Skill Structure

```
skills/
└── skill-name/
    ├── SKILL.md          # Main skill documentation
    ├── scripts/          # Optional helper scripts
    └── reference/        # Optional reference files
```

### Creating a New Skill

**Step 1:** Create skill directory:

```bash
mkdir {{ .chezmoi.sourceDir }}/dot_config/opencode/skills/my-skill
```

**Step 2:** Create `SKILL.md`:

```markdown
---
name: my-skill
description: What this skill helps with
---

# Skill: My Skill Name

## Overview

What this skill does and when to use it.

## When to Use

- Scenario 1
- Scenario 2

## Core Commands

### Example Command

```bash
# Description of what this does
command --flag value
```

## Workflow

1. Step one
2. Step two
3. Step three

## Decision Tree

```
Decision point?
├─ Option A?
│  └─ Do this
└─ Option B?
   └─ Do that
```

## Related

- Related skill 1
- Related skill 2
```

**Step 3:** Apply changes:

```bash
chezmoi apply --force ~/.config/opencode/skills/
```

### Loading Skills

Skills are automatically loaded from:
- Global: `~/.config/opencode/skills/`
- Project: `.opencode/skills/`

Use the `skill` tool to invoke them:

```
skill:name-of-skill
```

---

## 5. Configuration Schema Reference

### Top-Level Keys

```json
{
  "$schema": "https://opencode.ai/config.json",
  "model": "provider/model-id",
  "small_model": "provider/model-id",
  "instructions": ["path/to/instructions.md"],
  "permission": {
    "read": "allow" | "ask" | "deny",
    "edit": "allow" | "ask" | "deny",
    "bash": "allow" | "ask" | "deny"
  },
  "provider": { ... },
  "agent": { ... },
  "tools": { ... }
}
```

### Agent Configuration Schema

```json
{
  "agent-name": {
    "description": "string (required for subagents)",
    "mode": "primary" | "subagent" | "all",
    "model": "provider/model-id",
    "temperature": 0.0-1.0,
    "top_p": 0.0-1.0,
    "prompt": "string",
    "tools": {
      "write": boolean,
      "edit": boolean,
      "bash": boolean
    },
    "permission": {
      "edit": "ask" | "allow" | "deny",
      "bash": "ask" | "allow" | "deny"
    },
    "steps": number,
    "hidden": boolean
  }
}
```

### Provider Configuration Schema

```json
{
  "provider-id": {
    "npm": "@ai-sdk/package-name",
    "name": "Display Name",
    "options": {
      "baseURL": "https://api.endpoint.com/v1",
      "apiKey": "{env:ENV_VAR_NAME}",
      "timeout": 300000
    },
    "models": {
      "model-id": {
        "name": "Display Name",
        "limit": {
          "context": 128000,
          "output": 8192
        },
        "parameters": {
          "temperature": 0.3,
          "top_p": 0.95
        }
      }
    }
  }
}
```

---

## 6. Troubleshooting

### Changes Not Applied

```bash
# Check if chezmoi is tracking the file
chezmoi managed | grep opencode

# Force apply
chezmoi apply --force ~/.config/opencode/

# Check diff
chezmoi diff ~/.config/opencode/opencode.json
```

### Model Not Found

```bash
# List available models
opencode models

# Check provider credentials
opencode auth list
```

### Agent Not Showing

```bash
# Check agent mode
cat ~/.config/opencode/opencode.json | jq '.agent'

# Subagents must have 'mode: subagent' and 'description'
```

### Permission Errors

```bash
# Check chezmoi permissions
chezmoi doctor

# Ensure files are readable
ls -la ~/.config/opencode/
```

---

## 7. Best Practices

### DO

✅ Always edit files in `{{ .chezmoi.sourceDir | dir }}/` then apply with chezmoi
✅ Use version control (commit changes to the boilerplate repo)
✅ Test agents with simple tasks before complex work
✅ Document skills thoroughly
✅ Use `temperature: 0.1-0.3` for coding tasks
✅ Set specific tool permissions per agent

### DON'T

❌ Edit files directly in `~/.config/opencode/` (will be overwritten)
❌ Store API keys in the config file (use `/connect` or env vars)
❌ Create agents without descriptions
❌ Use high temperatures (>0.7) for precise tasks
❌ Forget to apply changes with chezmoi

---

## 8. Common Workflows

### Switching Models

```bash
# 1. Edit source config
vim {{ .chezmoi.sourceDir }}/dot_config/opencode/opencode.json

# 2. Update model field
# "model": "openrouter/new/model-id"

# 3. Apply
chezmoi apply --force ~/.config/opencode/opencode.json
```

### Adding a Project-Specific Agent

```bash
# 1. Create agent in project
cd /path/to/project
mkdir -p .opencode/agents

# 2. Create agent file
cat > .opencode/agents/backend.md << 'EOF'
---
description: Backend specialist for this project
mode: subagent
model: openrouter/deepseek/deepseek-chat
---

You are a backend specialist for this specific project...
EOF

# 3. Use immediately (no chezmoi needed for project configs)
```

### Updating Global Instructions

```bash
# 1. Edit AGENTS.md
vim {{ .chezmoi.sourceDir }}/dot_config/opencode/AGENTS.md

# 2. Apply
chezmoi apply --force ~/.config/opencode/AGENTS.md

# 3. Verify in new OpenCode session
```

---

## Related Resources

- [OpenCode Config Docs](https://opencode.ai/docs/config)
- [OpenCode Agents Docs](https://opencode.ai/docs/agents)
- [OpenCode Models Docs](https://opencode.ai/docs/models)
- [Chezmoi Documentation](https://www.chezmoi.io/)
- This machine's skill: `skill:opencode-config`