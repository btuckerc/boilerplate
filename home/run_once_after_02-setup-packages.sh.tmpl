{{- if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash
set -euo pipefail

echo ""
echo "========================================"
echo "  Homebrew Packages Setup"
echo "========================================"
echo ""

if ! command -v brew >/dev/null 2>&1; then
    if [ -t 0 ]; then
        echo "Homebrew not found (required for packages)"
        read -p "Would you like to install Homebrew? [Y/n] " -r resp
        if [[ ! "$resp" =~ ^[nN] ]]; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            if [[ $(uname -m) == "arm64" ]]; then
                eval "$(/opt/homebrew/bin/brew shellenv)"
            else
                eval "$(/usr/local/bin/brew shellenv)"
            fi
            echo "✓ Homebrew installed"
        else
            echo "Skipped. Install Homebrew later: https://brew.sh"
            exit 0
        fi
    else
        echo "Homebrew not found. Skipping package installation (non-interactive)"
        exit 0
    fi
fi

BREWFILE="$HOME/Brewfile"

if [ ! -f "$BREWFILE" ]; then
    echo "Brewfile not found. Skipping package installation."
    exit 0
fi

BREW_COUNT=$(grep -E '^(tap|brew|cask)' "$BREWFILE" | wc -l | tr -d ' ')

echo "Brewfile contains $BREW_COUNT core packages"
echo ""

if [ -t 0 ]; then
    read -p "Install Homebrew packages now? [Y/n] " -r resp
    if [[ "$resp" =~ ^n ]]; then
        echo "Skipped. Run 'brew-bundle-optional' later to install packages."
        exit 0
    fi
fi

echo ""
echo "Installing Homebrew packages..."

if command -v brew-bundle-optional >/dev/null 2>&1; then
    brew-bundle-optional "$BREWFILE"
else
    brew bundle --file="$BREWFILE"
fi

echo ""
echo "✓ Homebrew packages installed"
echo ""
{{- end -}}
