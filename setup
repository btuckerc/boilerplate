#!/usr/bin/env bash
set -euo pipefail

echo "Starting dotfiles setup..."
echo ""

# Check for Homebrew first (needed for chezmoi, mise, and packages)
if ! command -v brew >/dev/null 2>&1; then
    echo "Homebrew not found (important for automatic setup)"
    read -p "Would you like to install Homebrew? [Y/n] " -r resp
    if [[ ! "${resp,,}" =~ ^n ]]; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        
        if [[ $(uname -m) == "arm64" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        else
            eval "$(/usr/local/bin/brew shellenv)"
        fi
        echo "âœ“ Homebrew installed"
    else
        echo "Skipped Homebrew installation"
    fi
    echo ""
fi

# Set zsh as default shell if available
if command -v zsh >/dev/null 2>&1; then
    if [ "$SHELL" != "$(command -v zsh)" ]; then
        echo "Setting zsh as default shell..."
        sudo chsh -s "$(command -v zsh)" "$USER"
        echo "Default shell set to zsh (restart shell to apply)"
    fi
fi

DOTFILES_REPO="https://github.com/btuckerc/boilerplate.git"

# Install chezmoi if not present
if command -v chezmoi >/dev/null 2>&1; then
    echo "chezmoi already installed"
elif command -v brew >/dev/null 2>&1; then
    echo "Installing chezmoi via Homebrew..."
    brew install chezmoi
elif command -v mise >/dev/null 2>&1; then
    echo "Installing chezmoi via mise..."
    mise use --global chezmoi@latest
    eval "$(mise activate bash)"
elif command -v apt-get >/dev/null 2>&1; then
    echo "Installing chezmoi via apt..."
    sudo apt-get install -y chezmoi
else
    echo "Installing chezmoi via install script..."
    sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply "$DOTFILES_REPO"
    echo ""
    echo "Setup complete! Restart your shell or run: exec $SHELL"
    exit 0
fi

echo "Applying dotfiles..."
chezmoi init --apply "$DOTFILES_REPO"

echo ""
echo "Setup complete! Restart your shell or run: exec $SHELL"
