#!/bin/bash
# Copyright (c) 2024 Tucker Craig
# See LICENSE file for full license details.

# Get the absolute directory of the current script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source common utilities
source "$SCRIPT_DIR/../utils/scripts/common.sh"

# VSCode config paths
VSCODE_CONFIG_DIR="$HOME/Library/Application Support/Code/User"
VSCODE_EXTENSIONS_DIR="$HOME/.vscode/extensions"
REPO_CONFIG_DIR="$REPO_ROOT/config/vscode"
REPO_EXTENSION_DIR="$REPO_CONFIG_DIR/extensions/adwaita-theme"

# Create necessary directories
mkdir -p "$REPO_CONFIG_DIR/snippets"
mkdir -p "$VSCODE_EXTENSIONS_DIR"

# Function to backup and symlink a file
backup_and_symlink() {
    local source_file="$1"
    local target_file="$2"
    local backup_file="${source_file}.backup-$(date +%Y%m%d_%H%M%S)"

    # Check if source file exists
    if [ ! -f "$source_file" ]; then
        echo "Warning: Source file $source_file does not exist. Creating new symlink..."
    elif [ ! -L "$source_file" ]; then
        echo "Backing up $source_file to $backup_file"
        cp "$source_file" "$backup_file"
    fi

    # Remove existing file/symlink
    rm -f "$source_file"

    # Create symlink
    echo "Creating symlink for $(basename "$source_file")"
    ln -s "$target_file" "$source_file"
}

# Handle settings.json
echo "Setting up settings.json..."
backup_and_symlink "$VSCODE_CONFIG_DIR/settings.json" "$REPO_CONFIG_DIR/settings.json"

# Handle theme extension
echo "Setting up theme extension..."
extension_dir="$VSCODE_EXTENSIONS_DIR/adwaita-theme"
if [ -d "$extension_dir" ]; then
    echo "Removing existing theme extension..."
    rm -rf "$extension_dir"
fi
echo "Installing theme extension..."
ln -s "$REPO_EXTENSION_DIR" "$extension_dir"

# Handle themes
echo "Setting up themes..."
for theme_file in "$REPO_CONFIG_DIR/themes"/*.json; do
    if [ -f "$theme_file" ]; then
        filename=$(basename "$theme_file")
        backup_and_symlink "$VSCODE_CONFIG_DIR/themes/$filename" "$theme_file"
    fi
done

# Handle snippets
echo "Setting up snippets..."
for snippet_file in "$VSCODE_CONFIG_DIR/snippets"/*.json; do
    if [ -f "$snippet_file" ]; then
        filename=$(basename "$snippet_file")
        backup_and_symlink "$snippet_file" "$REPO_CONFIG_DIR/snippets/$filename"
    fi
done

echo "âœ¨ VSCode configuration setup complete!"
echo "Your settings and snippets are now linked to the repository."
echo "Original files have been backed up with timestamp suffix."
